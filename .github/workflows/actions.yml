name: Sanity
on:
  push:
    branches:
      - 'main'
  pull_request:
    branches:
      - 'main'
env:
  GTEST_OUTPUT: xml:./
jobs:
  what_to_make:
    runs-on: ubuntu-22.04
    _is_main_expr: &is_main "steps.check-main-push.outputs.is-main-push == '1'"
    _changed_expr: &changed "fromJSON(steps.check-diffs.outputs.components)"
    _is_ci_expr: &is_ci "contains(*changed, 'ci')"
    _is_main_or_ci_expr: &is_main_or_ci "*is_main || *is_ci"
    _do_cli_expr: &do_cli "*is_main_or_ci || contains(*changed, 'cli')"
    _do_daemon_expr: &do_daemon "*is_main_or_ci || contains(*changed, 'daemon')"
    _do_gtk_expr: &do_gtk "*is_main_or_ci || contains(*changed, 'gtk')"
    _do_mac_expr: &do_mac "*is_main_or_ci || contains(*changed, 'mac')"
    _do_qt_expr: &do_qt "*is_main_or_ci || contains(*changed, 'qt')"
    _do_web_expr: &do_web "*is_main || contains(*changed, 'web')"
    _do_tests_expr: &do_tests "*is_main_or_ci || contains(*changed, 'tests')"
    # tests require transmission-show, so do_utils |= do_tests
    _do_utils_expr: &do_utils "*do_tests || contains(*changed, 'utils')"
    outputs:
      make_android: ${{ *is_main_or_ci || contains(*changed, 'android') }}
      make_cli: ${{ *do_cli }}
      make_core: ${{ *is_main_or_ci || contains(*changed, 'core') }}
      make_daemon: ${{ do_daemon }}
      make_dist: ${{ *is_main_or_ci || contains(*changed, 'dist') }}
      make_docs: ${{ *is_main || contains(*changed, 'docs') }}
      make_gtk: ${{ *do_gtk }}
      make_mac: ${{ *do_mac }}
      make_qt: ${{ *do_qt }}
      make_tarball: ${{ *is_main_or_ci || contains(*changed, 'any') }}
      make_tests: ${{ *do_tests }}
      make_utils: ${{ *do_utils }}
      make_web: ${{ *do_web }}
      test_style: ${{ *is_main_or_ci || contains(*changed, 'our_code') }}
      cmake_enable_cli: ${{ *do_cli == 'true' && 'ON' || 'OFF' }}
      cmake_enable_daemon: ${{ *do_daemon == 'true' && 'ON' || 'OFF' }}
      cmake_enable_gtk: ${{ *do_gtk == 'true' && 'ON' || 'OFF' }}
      cmake_enable_mac: ${{ *do_mac == 'true' && 'ON' || 'OFF' }}
      cmake_enable_qt: ${{ *do_qt == 'true' && 'ON' || 'OFF' }}
      cmake_enable_tests: ${{ *do_tests == 'true' && 'ON' || 'OFF' }}
      cmake_enable_utils: ${{ *do_utils == 'true' && 'ON' || 'OFF' }}
      cmake_rebuild_web: ${{ *do_web == 'true' && 'ON' || 'OFF' }}
    steps:
      - name: Check Push to Main Branch
        id: check-main-push
        run: |
          set -x
          if [ "$GITHUB_EVENT_NAME" = 'push' ] && [ "$GITHUB_REF_NAME" = 'main' ]; then
            echo is-main-push=1 >> "$GITHUB_OUTPUT"
          else
            echo is-main-push=0 >> "$GITHUB_OUTPUT"
          fi
      - name: Get Source
        id: get-source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: src
          submodules: recursive
      - name: Check for diffs
        id: check-diffs
        run: |
          set +e
          cd src
          MERGE_BASE=$(git merge-base origin/main HEAD)
          components=()
          function get_changes() { # name, paths...
            local name="$1"
            shift
            if ! git diff --quiet --exit-code "$MERGE_BASE" -- "$@"; then
              components+=("$name")
            fi
          }

          BUILD_FILES_CMAKE=(CMakeLists.txt cmake)
          BUILD_FILES_XCODE=(Transmission.xcodeproj)
          BUILD_FILES=("${BUILD_FILES_CMAKE[@]}" "${BUILD_FILES_XCODE[@]}")
          CORE_FILES=("${BUILD_FILES[@]}" libtransmission third-party)
          ANY_FILES=("${CORE_FILES[@]}" cli daemon gtk macosx qt tests utils web)
          CI_FILES=(.github/workflows)

          get_changes android  "${CORE_FILES[@]}" android
          get_changes any      "${CORE_FILES[@]}" cli daemon gtk macosx qt utils tests web
          get_changes ci       "${CI_FILES[@]}"
          get_changes cli      "${CORE_FILES[@]}" cli
          get_changes core     "${CORE_FILES[@]}"
          get_changes daemon   "${CORE_FILES[@]}" daemon
          get_changes dist     dist release
          get_changes docs     docs
          get_changes gtk      "${CORE_FILES[@]}" gtk
          get_changes mac      "${CORE_FILES[@]}" macosx
          get_changes our_code "${BUILD_FILES[@]}" libtransmission cli daemon gtk macosx qt utils tests web
          get_changes qt       "${CORE_FILES[@]}" qt
          get_changes tests    "${CORE_FILES[@]}" utils tests
          get_changes utils    "${CORE_FILES[@]}" utils
          get_changes web      "${BUILD_FILES_CMAKE[@]}" web

          printf 'components=%s\n' "$(printf '%s\n' "${components[@]}" | jq -R . | jq -cs .)" >> "$GITHUB_OUTPUT"
          cat "$GITHUB_OUTPUT"

  code-style:
    runs-on: ubuntu-22.04
    needs: [ what_to_make ]
    if: ${{ needs.what_to_make.outputs.test_style == 'true' }}
    steps:
      - name: Show Configuration
        run: |
          echo '${{ toJSON(needs) }}'
          echo '${{ toJSON(runner) }}'
          cat /etc/os-release
      - name: Get Source
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Get Dependencies
        run: |
          set -ex
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          sudo add-apt-repository "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main"
          sudo apt-get install -y clang-format-17
      - name: Get NPM
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Check for style diffs
        id: check-for-diffs
        working-directory: .
        run: |
          ./code_style.sh
          set +e
          git diff --exit-code > style.diff
          echo "differs=$?" >> $GITHUB_OUTPUT
          cat style.diff
          set -e
      - name: Upload Diffs
        uses: actions/upload-artifact@v4
        if: ${{ steps.check-for-diffs.outputs.differs == '1' }}
        with:
          name: code-style.diff
          path: 'style.diff'
      - name: Fail if diffs exist
        if: ${{ steps.check-for-diffs.outputs.differs == '1' }}
        run: |
          echo "code style does not match expected."
          cat style.diff
          echo "When CI is done, the above patch will be uploaded as 'code-style.diff' to https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}/ ."
          exit 1

  sanitizer-tests-ubuntu:
    runs-on: ubuntu-22.04
    needs: [what_to_make]
    if: ${{ needs.what_to_make.outputs.make_tests == 'true' }}
    steps:
      - name: Show Configuration
        run: |
          echo '${{ toJSON(needs) }}'
          echo '${{ toJSON(runner) }}'
          cat /etc/os-release
      - name: Get Dependencies
        run: |
          set -ex
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ca-certificates \
            clang \
            cmake \
            gettext \
            libcurl4-openssl-dev \
            libdeflate-dev \
            libevent-dev \
            libfmt-dev \
            libminiupnpc-dev \
            libnatpmp-dev \
            libpsl-dev \
            libssl-dev \
            ninja-build
      - name: Get Source
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: src
      - name: Configure
        run: |
          cmake \
            -S src \
            -B obj \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_COMPILER='clang++' \
            -DCMAKE_CXX_FLAGS='-gdwarf-4 -fno-omit-frame-pointer -fsanitize=address,leak,undefined' \
            -DCMAKE_C_COMPILER='clang' \
            -DCMAKE_C_FLAGS='-gdwarf-4 -fno-omit-frame-pointer -fsanitize=address,leak,undefined' \
            -DCMAKE_INSTALL_PREFIX=pfx \
            -DENABLE_CLI=OFF \
            -DENABLE_DAEMON=OFF \
            -DENABLE_GTK=OFF \
            -DENABLE_MAC=OFF \
            -DENABLE_QT=OFF \
            -DENABLE_TESTS=ON \
            -DENABLE_UTILS=ON \
            -DREBUILD_WEB=OFF \
            -DRUN_CLANG_TIDY=OFF
      - name: Make
        run: cmake --build obj --config Debug --target libtransmission-test transmission-show
      - name: Test with sanitizers
        run: cmake -E chdir obj ctest -j $(nproc) --build-config Debug --output-on-failure

  sanitizer-tests-macos:
    runs-on: macos-26
    needs: [ what_to_make ]
    if: ${{ needs.what_to_make.outputs.make_tests == 'true' }}
    steps:
      - name: Show Configuration
        run: |
          echo '${{ toJSON(needs) }}'
          echo '${{ toJSON(runner) }}'
          sw_vers
      - name: Get Dependencies
        run: brew install --formulae cmake gettext libdeflate libevent libpsl miniupnpc ninja node pkgconf
      - name: Get Source
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: src
      - name: Configure
        run: |
          cmake \
            -S src \
            -B obj \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS='-gdwarf-4 -fno-omit-frame-pointer -fsanitize=address,undefined' \
            -DCMAKE_C_FLAGS='-gdwarf-4 -fno-omit-frame-pointer -fsanitize=address,undefined' \
            -DCMAKE_INSTALL_PREFIX=pfx \
            -DENABLE_CLI=OFF \
            -DENABLE_DAEMON=OFF \
            -DENABLE_GTK=OFF \
            -DENABLE_MAC=OFF \
            -DENABLE_QT=OFF \
            -DENABLE_TESTS=ON \
            -DENABLE_UTILS=ON \
            -DREBUILD_WEB=OFF \
            -DRUN_CLANG_TIDY=OFF
      - name: Make
        run: cmake --build obj --config Debug --target libtransmission-test transmission-show
      - name: Test with sanitizers
        run: cmake -E chdir obj ctest -j $(nproc) --build-config Debug --output-on-failure

  clang-tidy-libtransmission:
    runs-on: ubuntu-24.04
    needs: [ what_to_make ]
    if: ${{ needs.what_to_make.outputs.make_core == 'true' || needs.what_to_make.outputs.make_tests == 'true' }}
    steps:
      - name: Show Configuration
        run: |
          echo '${{ toJSON(needs) }}'
          echo '${{ toJSON(runner) }}'
          cat /etc/os-release
      - name: Get Dependencies
        run: |
          set -ex
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ca-certificates \
            clang \
            clang-tidy \
            cmake \
            gettext \
            libcurl4-openssl-dev \
            libdeflate-dev \
            libevent-dev \
            libfmt-dev \
            libminiupnpc-dev \
            libnatpmp-dev \
            libpsl-dev \
            libssl-dev \
            ninja-build
      - name: Get NPM
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Get Source
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: src
      - name: Configure
        run: |
          cmake \
            -S src \
            -B obj \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_COMPILER='clang++' \
            -DCMAKE_C_COMPILER='clang' \
            -DCMAKE_INSTALL_PREFIX=pfx \
            -DENABLE_TESTS=${{ needs.what_to_make.outputs.cmake_enable_tests }} \
            -DRUN_CLANG_TIDY=ON
      - name: Make (Core)
        run: cmake --build obj --config Debug --target transmission 2>&1 | tee makelog
      - name: Make (Tests)
        if: ${{ needs.what_to_make.outputs.make_tests == 'true' }}
        run: cmake --build obj --config Debug --target libtransmission-test 2>&1 | tee -a makelog
      - name: Test for warnings
        run: |
          if grep 'warning:' makelog; then exit 1; fi

  clang-tidy-libtransmission-win32:
    runs-on: windows-2022
    needs: [ what_to_make ]
    if: ${{ needs.what_to_make.outputs.make_core == 'true' || needs.what_to_make.outputs.make_tests == 'true' }}
    steps:
      - name: Show Configuration
        run: |
          echo '${{ toJSON(needs) }}'
          echo '${{ toJSON(runner) }}'
      - name: Get Source
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: src
      - name: Prepare Build Deps
        uses: ./src/.github/actions/prepare-deps-win32
        with:
          arch: x64
          type: CoreDeps
      - name: Configure
        run: |
          Import-VisualStudioVars -VisualStudioVersion 2022 -Architecture x64
          cmake `
            -S src `
            -B obj `
            -G Ninja `
            -DCMAKE_BUILD_TYPE=Debug `
            -DCMAKE_PREFIX_PATH="${Env:DEPS_PREFIX}" `
            -DENABLE_TESTS=${{ needs.what_to_make.outputs.cmake_enable_tests }} `
            -DRUN_CLANG_TIDY=ON
      - name: Make (Core)
        run: |
          Import-VisualStudioVars -VisualStudioVersion 2022 -Architecture x64
          cmake --build obj --config Debug --target transmission 2>&1 | tee makelog
      - name: Make (Tests)
        if: ${{ needs.what_to_make.outputs.make_tests == 'true' }}
        run: |
          Import-VisualStudioVars -VisualStudioVersion 2022 -Architecture x64
          cmake --build obj --config Debug --target libtransmission-test 2>&1 | tee -a makelog
      - name: Test for warnings
        run: |
          if (Select-String -Path makelog -Pattern 'warning:') { exit 1 }

  macos-26-project:
     runs-on: macos-26
     needs: [ what_to_make ]
     if: ${{ needs.what_to_make.outputs.make_cli == 'true' ||
             needs.what_to_make.outputs.make_daemon == 'true' ||
             needs.what_to_make.outputs.make_mac == 'true' ||
             needs.what_to_make.outputs.make_utils == 'true' }}
     steps:
       - name: Show Configuration
         run: |
           echo '${{ toJSON(needs) }}'
           echo '${{ toJSON(runner) }}'
           sw_vers
       - name: Get Source
         uses: actions/checkout@v4
         with:
           path: src
           submodules: recursive
       - name: Build
         run: xcodebuild -project src/Transmission.xcodeproj
       - uses: actions/upload-artifact@v4
         with:
           name: binaries-${{ github.job }}
           path: pfx/**/*

  macos-26-arm64:
    runs-on: macos-26
    needs: [ what_to_make ]
    if: ${{ needs.what_to_make.outputs.make_cli == 'true' ||
            needs.what_to_make.outputs.make_daemon == 'true' ||
            needs.what_to_make.outputs.make_gtk == 'true' ||
            needs.what_to_make.outputs.make_mac == 'true' ||
            needs.what_to_make.outputs.make_qt == 'true' ||
            needs.what_to_make.outputs.make_tests == 'true' ||
            needs.what_to_make.outputs.make_utils == 'true' }}
    steps:
      - name: Show Configuration
        run: |
          echo '${{ toJSON(needs) }}'
          echo '${{ toJSON(runner) }}'
          sw_vers
      - name: Get Dependencies
        run: brew install --formulae cmake gettext libdeflate libevent libpsl miniupnpc ninja node pkgconf crc32c
      - name: Get Dependencies (GTK)
        if: ${{ needs.what_to_make.outputs.make_gtk == 'true' }}
        run: brew install --formula gtkmm3
      - name: Get Dependencies (Qt)
        if: ${{ needs.what_to_make.outputs.make_qt == 'true' }}
        run: brew install --formula qt
      - name: Get Source
        uses: actions/checkout@v4
        with:
          path: src
          submodules: recursive
      - name: Configure
        run: |
          cmake \
            -S src \
            -B obj \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_INSTALL_PREFIX=pfx \
            -DCMAKE_OSX_ARCHITECTURES='arm64' \
            -DCMAKE_PREFIX_PATH=`brew --prefix`/opt/qt \
            -DENABLE_CLI=${{ needs.what_to_make.outputs.cmake_enable_cli }} \
            -DENABLE_DAEMON=${{ needs.what_to_make.outputs.cmake_enable_daemon }} \
            -DENABLE_GTK=${{ (needs.what_to_make.outputs.cmake_enable_gtk }} \
            -DENABLE_MAC=${{ (needs.what_to_make.outputs.cmake_enable_mac }} \
            -DENABLE_QT=${{ needs.what_to_make.outputs.cmake_enable_qt }} \
            -DENABLE_TESTS=${{ needs.what_to_make.outputs.cmake_enable_tests }} \
            -DENABLE_UTILS=${{ needs.what_to_make.outputs.cmake_enable_utils }} \
            -DREBUILD_WEB=${{ needs.what_to_make.outputs.cmake_rebuild_web }}
            -DENABLE_WERROR=ON \
            -DRUN_CLANG_TIDY=OFF \
            -DUSE_SYSTEM_Crc32c=ON
      - name: Make
        run: cmake --build obj --config RelWithDebInfo
      - name: Test
        if: ${{ needs.what_to_make.outputs.make_tests == 'true' }}
        env:
          TMPDIR: /private/tmp
        run: cmake -E chdir obj ctest -j $(sysctl -n hw.logicalcpu) --build-config RelWithDebInfo --output-on-failure
      - name: Install
        run: cmake --build obj --config RelWithDebInfo --target install/strip
      - uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ github.job }}
          path: pfx/**/*

  # oldest GitHub build support on macOS (Transmission supports macOS 11.0 and newer)
  macos-13:
    runs-on: macos-13
    needs: [ what_to_make ]
    if: ${{ needs.what_to_make.outputs.make_mac == 'true' }}
    steps:
      - name: Show Configuration
        run: |
          echo '${{ toJSON(needs) }}'
          echo '${{ toJSON(runner) }}'
          sw_vers
      - name: Get Dependencies
        run: brew install --formulae cmake gettext libdeflate libevent libpsl miniupnpc ninja node pkgconf crc32c
      - name: Get Source
        uses: actions/checkout@v4
        with:
          path: src
          submodules: recursive
      # oldest GitHub build support for Xcode (Transmission supports Xcode 12.5.1 and newer)
      - name: Set Xcode to 14.1
        run: |
          # https://github.com/actions/runner-images/blob/main/images/macos/macos-13-Readme.md#xcode
          sudo xcode-select --switch /Applications/Xcode_14.1.app
      - name: Configure
        run: |
          cmake \
            -S src \
            -B obj \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_INSTALL_PREFIX=pfx \
            -DCMAKE_OSX_ARCHITECTURES='x86_64' \
            -DENABLE_GTK=OFF \
            -DENABLE_MAC=${{ (needs.what_to_make.outputs.cmake_enable_mac }} \
            -DENABLE_QT=OFF \
            -DENABLE_TESTS=OFF \
            -DENABLE_WERROR=ON \
            -DRUN_CLANG_TIDY=OFF \
            -DUSE_SYSTEM_CRC32C=ON
      - name: Make
        run: cmake --build obj --config RelWithDebInfo

  alpine-musl:
    needs: [ what_to_make ]
    runs-on: ubuntu-22.04
    container:
      image: alpine:latest
    if: ${{ needs.what_to_make.outputs.make_cli == 'true' || needs.what_to_make.outputs.make_daemon == 'true' || needs.what_to_make.outputs.make_gtk == 'true' || needs.what_to_make.outputs.make_qt == 'true' || needs.what_to_make.outputs.make_tests == 'true' || needs.what_to_make.outputs.make_utils == 'true' }}
    steps:
      - name: Show Configuration
        run: |
          echo '${{ toJSON(needs) }}'
          echo '${{ toJSON(runner) }}'
          cat /etc/os-release
      - name: Get Dependencies
        run: |
          set -ex
          apk update
          apk add \
            ca-certificates \
            cmake \
            crc32c-dev \
            curl-dev \
            fmt-dev \
            g++ \
            gettext-dev \
            git \
            libevent-dev \
            libpsl \
            linux-headers \
            miniupnpc-dev \
            ninja \
            npm \
            pkgconfig \
            xz
      - name: Get Dependencies (GTK)
        if: ${{ needs.what_to_make.outputs.make_gtk == 'true' }}
        run: apk add --upgrade glibmm-dev gtkmm3-dev
      - name: Get Dependencies (Qt6)
        if: ${{ needs.what_to_make.outputs.make_qt == 'true' }}
        run: apk add --upgrade qt6-qttools-dev qt6-qtsvg-dev
      - name: Get Source
        uses: actions/checkout@v4
        with:
          path: src
          submodules: recursive
      - name: Configure
        run: |
          cmake \
            -S src \
            -B obj \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_INSTALL_PREFIX=pfx \
            -DENABLE_CLI=${{ (needs.what_to_make.outputs.cmake_enable_cli }} \
            -DENABLE_DAEMON=${{ needs.what_to_make.outputs.cmake_enable_daemon }} \
            -DENABLE_GTK=${{ (needs.what_to_make.outputs.cmake_enable_gtk }} \
            -DENABLE_MAC=OFF \
            -DENABLE_QT=${{ needs.what_to_make.outputs.cmake_enable_qt }} \
            -DENABLE_TESTS=ON \
            -DENABLE_UTILS=ON \
            -DREBUILD_WEB=${{ needs.what_to_make.outputs.cmake_rebuild_web }} \
            -DENABLE_WERROR=ON \
            -DRUN_CLANG_TIDY=OFF \
            -DUSE_SYSTEM_CRC32C=ON
      - name: Make
        run: cmake --build obj --config RelWithDebInfo
      - name: Test
        if: ${{ needs.what_to_make.outputs.make_tests == 'true' }}
        env:
          TMPDIR: /private/tmp
        run: cmake -E chdir obj ctest -j $(nproc) --build-config RelWithDebInfo --output-on-failure
      - name: Install
        run: cmake --build obj --config RelWithDebInfo --target install/strip
      - uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ github.job }}
          path: pfx/**/*

  windows:
    needs: [ what_to_make ]
    runs-on: windows-2022
    if: ${{ needs.what_to_make.outputs.make_cli == 'true' || needs.what_to_make.outputs.make_daemon == 'true' || needs.what_to_make.outputs.make_dist == 'true' || needs.what_to_make.outputs.make_qt == 'true' || needs.what_to_make.outputs.make_tests == 'true' || needs.what_to_make.outputs.make_utils == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, x86]
    steps:
      - name: Show Configuration
        run: |
          echo '${{ toJSON(needs) }}'
          echo '${{ toJSON(runner) }}'
      - name: Get Source
        uses: actions/checkout@v4
        with:
          path: src
          submodules: recursive
      - name: Prepare Build Deps
        uses: ./src/.github/actions/prepare-deps-win32
        with:
          arch: ${{ matrix.arch }}
          type: Deps
      - name: Configure
        run: |
          Import-VisualStudioVars -VisualStudioVersion 2022 -Architecture ${{ matrix.arch }}
          cmake `
            -S src `
            -B obj `
            -G Ninja `
            -DCMAKE_BUILD_TYPE=RelWithDebInfo `
            -DCMAKE_INSTALL_PREFIX=pfx `
            -DCMAKE_PREFIX_PATH="${Env:DEPS_PREFIX}" `
            -DENABLE_CLI=${{ (needs.what_to_make.outputs.cmake_enable_cli }} `
            -DENABLE_DAEMON=${{ needs.what_to_make.outputs.cmake_enable_daemon }} `
            -DENABLE_GTK=OFF `
            -DENABLE_MAC=OFF `
            -DENABLE_QT=${{ needs.what_to_make.outputs.cmake_enable_qt }} `
            -DENABLE_TESTS=${{ needs.what_to_make.outputs.cmake_enable_tests }} `
            -DENABLE_UTILS=ON `
            -DREBUILD_WEB=${{ needs.what_to_make.outputs.cmake_rebuild_web }}
            -DENABLE_WERROR=ON `
            -DRUN_CLANG_TIDY=OFF
      - name: Make
        run: |
          Import-VisualStudioVars -VisualStudioVersion 2022 -Architecture ${{ matrix.arch }}
          cmake --build obj --config RelWithDebInfo
      - name: Test
        if: ${{ needs.what_to_make.outputs.make_tests == 'true' }}
        run: cmake -E chdir obj ctest -j $(nproc) --build-config RelWithDebInfo --output-on-failure --timeout 600
      - name: Install
        run: cmake --build obj --config RelWithDebInfo --target install
      - name: Package
        if: ${{ needs.what_to_make.outputs.make_dist == 'true' || (needs.what_to_make.outputs.make_daemon == 'true' && needs.what_to_make.outputs.make_qt == 'true') }}
        run: |
          Import-VisualStudioVars -VisualStudioVersion 2022 -Architecture ${{ matrix.arch }}
          cmake --build obj --config RelWithDebInfo --target pack-msi
      - uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ github.job }}-${{ matrix.arch }}
          path: pfx/**/*
      - uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ github.job }}-${{ matrix.arch }}-msi
          path: obj/dist/msi/*.msi

  make-source-tarball:
    runs-on: ubuntu-22.04
    needs: [ what_to_make ]
    if: ${{ needs.what_to_make.outputs.make_tarball == 'true' }}
    steps:
      - name: Show Configuration
        run: |
          echo '${{ toJSON(needs) }}'
          echo '${{ toJSON(runner) }}'
          cat /etc/os-release
      - name: Get Dependencies
        run: |
          set -ex
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ca-certificates \
            cmake \
            libcurl4-openssl-dev \
            libssl-dev \
            ninja-build
      - name: Get Source
        uses: actions/checkout@v4
        with:
          path: src
          submodules: recursive
      - name: Configure
        run: |
          cmake \
            -S src \
            -B obj \
            -G Ninja
      - name: Create source tarball
        run: cmake --build obj --target package_source
      - uses: actions/upload-artifact@v4
        with:
          name: source-tarball
          path: obj/transmission*.tar.*

  macos-26-universal-from-tarball:
    needs: [ make-source-tarball, what_to_make ]
    if: ${{ needs.what_to_make.outputs.make_mac == 'true' }}
    runs-on: macos-26
    steps:
      - name: Show Configuration
        run: |
          echo '${{ toJSON(needs) }}'
          echo '${{ toJSON(runner) }}'
          sw_vers
      - name: Get Dependencies
        run: brew install --formulae cmake ninja node pkgconf
      - name: Get Source
        uses: actions/download-artifact@v4
        with:
          name: source-tarball
      - name: Extract Source
        run: mkdir src && tar xf transmission*.tar.* -C src --strip-components 1
      - name: Configure
        run: |
          cmake \
            -S src \
            -B obj \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_INSTALL_PREFIX=pfx \
            -DCMAKE_OSX_ARCHITECTURES='x86_64;arm64' \
            -DCMAKE_DISABLE_FIND_PACKAGE_Intl=ON \
            -DENABLE_CLI=${{ (needs.what_to_make.outputs.cmake_enable_cli }} \
            -DENABLE_DAEMON=${{ needs.what_to_make.outputs.cmake_enable_daemon }} \
            -DENABLE_GTK=OFF \
            -DENABLE_MAC=${{ (needs.what_to_make.outputs.cmake_enable_mac }}
            -DENABLE_QT=OFF \
            -DENABLE_TESTS=${{ needs.what_to_make.outputs.cmake_enable_tests }} \
            -DENABLE_UTILS=${{ needs.what_to_make.outputs.cmake_enable_utils }} \
            -DREBUILD_WEB=${{ needs.what_to_make.outputs.cmake_rebuild_web }}
            -DENABLE_WERROR=ON \
            -DRUN_CLANG_TIDY=OFF \
            -DUSE_SYSTEM_EVENT2=OFF \
            -DUSE_SYSTEM_DEFLATE=OFF \
            -DUSE_SYSTEM_DHT=OFF \
            -DUSE_SYSTEM_MINIUPNPC=OFF \
            -DUSE_SYSTEM_NATPMP=OFF \
            -DUSE_SYSTEM_UTP=OFF \
            -DUSE_SYSTEM_B64=OFF \
            -DUSE_SYSTEM_PSL=OFF
      - name: Make
        run: cmake --build obj --config RelWithDebInfo
      - name: Test
        if: ${{ needs.what_to_make.outputs.make_tests == 'true' }}
        env:
          TMPDIR: /private/tmp
        run: cmake -E chdir obj ctest -j $(sysctl -n hw.logicalcpu) --build-config RelWithDebInfo --output-on-failure
      - name: Install
        run: cmake --build obj --config RelWithDebInfo --target install/strip
      - uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ github.job }}
          path: pfx/**/*

  # Oldest GitHub support for CLI, GTK and QT on Mac
  macos-13-x86_64-from-tarball:
    needs: [ make-source-tarball, what_to_make ]
    if: ${{ needs.what_to_make.outputs.make_cli == 'true' ||
            needs.what_to_make.outputs.make_daemon == 'true' ||
            needs.what_to_make.outputs.make_gtk == 'true' ||
            needs.what_to_make.outputs.make_mac == 'true' ||
            needs.what_to_make.outputs.make_qt == 'true' ||
            needs.what_to_make.outputs.make_tests == 'true' ||
            needs.what_to_make.outputs.make_utils == 'true' }}
    runs-on: macos-13
    steps:
      - name: Show Configuration
        run: |
          echo '${{ toJSON(needs) }}'
          echo '${{ toJSON(runner) }}'
          sw_vers
      - name: Get Dependencies
        run: brew install --formulae cmake gettext ninja node pkgconf
      - name: Get Dependencies (GTK)
        if: ${{ needs.what_to_make.outputs.make_gtk == 'true' }}
        run: brew install --formula gtkmm3
      - name: Get Dependencies (Qt)
        if: ${{ needs.what_to_make.outputs.make_qt == 'true' }}
        run: brew install --formula qt
      - name: Get Source
        uses: actions/download-artifact@v4
        with:
          name: source-tarball
      - name: Extract Source
        run: mkdir src && tar xf transmission*.tar.* -C src --strip-components 1
      - name: Configure
        run: |
          cmake \
            -S src \
            -B obj \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_INSTALL_PREFIX=pfx \
            -DCMAKE_OSX_ARCHITECTURES='x86_64' \
            -DCMAKE_PREFIX_PATH=`brew --prefix`/opt/qt \
            -DENABLE_CLI=${{ (needs.what_to_make.outputs.cmake_enable_cli }} \
            -DENABLE_DAEMON=${{ needs.what_to_make.outputs.cmake_enable_daemon }} \
            -DENABLE_GTK=${{ (needs.what_to_make.outputs.cmake_enable_gtk }} \
            -DENABLE_MAC=${{ (needs.what_to_make.outputs.cmake_enable_mac }} \
            -DENABLE_QT=${{ needs.what_to_make.outputs.cmake_enable_qt }} \
            -DENABLE_TESTS=${{ needs.what_to_make.outputs.cmake_enable_tests }} \
            -DENABLE_UTILS=${{ needs.what_to_make.outputs.cmake_enable_utils }} \
            -DREBUILD_WEB=${{ needs.what_to_make.outputs.cmake_rebuild_web }}
            -DENABLE_WERROR=ON \
            -DRUN_CLANG_TIDY=OFF \
            -DUSE_SYSTEM_EVENT2=OFF \
            -DUSE_SYSTEM_DEFLATE=OFF \
            -DUSE_SYSTEM_DHT=OFF \
            -DUSE_SYSTEM_MINIUPNPC=OFF \
            -DUSE_SYSTEM_NATPMP=OFF \
            -DUSE_SYSTEM_UTP=OFF \
            -DUSE_SYSTEM_B64=OFF \
            -DUSE_SYSTEM_PSL=OFF
      - name: Make
        run: cmake --build obj --config RelWithDebInfo
      - name: Test
        if: ${{ needs.what_to_make.outputs.make_tests == 'true' }}
        env:
          TMPDIR: /private/tmp
        run: cmake -E chdir obj ctest -j $(sysctl -n hw.logicalcpu) --build-config RelWithDebInfo --output-on-failure
      - name: Install
        run: cmake --build obj --config RelWithDebInfo --target install/strip
      - uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ github.job }}
          path: pfx/**/*

  debian-11-from-tarball:
    needs: [ make-source-tarball, what_to_make ]
    if: ${{ needs.what_to_make.outputs.make_cli == 'true' || needs.what_to_make.outputs.make_daemon == 'true' || needs.what_to_make.outputs.make_gtk == 'true' || needs.what_to_make.outputs.make_qt == 'true' || needs.what_to_make.outputs.make_tests == 'true' || needs.what_to_make.outputs.make_utils == 'true' }}
    runs-on: ubuntu-22.04
    container:
      image: debian:11-slim
    steps:
      - name: Show Configuration
        run: |
          echo '${{ toJSON(needs) }}'
          echo '${{ toJSON(runner) }}'
          cat /etc/os-release
      - name: Get Dependencies
        run: |
          set -ex
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates \
            cmake \
            g++ \
            gettext \
            libcurl4-openssl-dev \
            libdeflate-dev \
            libevent-dev \
            libfmt-dev \
            libminiupnpc-dev \
            libnatpmp-dev \
            libpsl-dev \
            libssl-dev \
            ninja-build \
            pkg-config \
            xz-utils
      - name: Get NPM
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Get Dependencies (GTK)
        if: ${{ needs.what_to_make.outputs.make_gtk == 'true' }}
        run: apt-get install -y --no-install-recommends libglibmm-2.4-dev libgtkmm-3.0-dev
      - name: Get Dependencies (Qt5)
        if: ${{ needs.what_to_make.outputs.make_qt == 'true' }}
        run: apt-get install -y --no-install-recommends qtbase5-dev libqt5svg5-dev qttools5-dev
      - name: Get Source
        uses: actions/download-artifact@v4
        with:
          name: source-tarball
      - name: Extract Source
        run: mkdir src && tar xf transmission*.tar.* -C src --strip-components 1
      - name: Configure
        run: |
          cmake \
            -S src \
            -B obj \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_INSTALL_PREFIX=pfx \
            -DENABLE_CLI=${{ (needs.what_to_make.outputs.cmake_enable_cli }} \
            -DENABLE_DAEMON=${{ needs.what_to_make.outputs.cmake_enable_daemon }} \
            -DENABLE_GTK=${{ (needs.what_to_make.outputs.cmake_enable_gtk }} \
            -DENABLE_MAC=OFF \
            -DENABLE_QT=${{ needs.what_to_make.outputs.cmake_enable_qt }} \
            -DENABLE_TESTS=${{ needs.what_to_make.outputs.cmake_enable_tests }} \
            -DENABLE_UTILS=${{ needs.what_to_make.outputs.cmake_enable_utils }} \
            -DREBUILD_WEB=${{ needs.what_to_make.outputs.cmake_rebuild_web }}
            -DENABLE_WERROR=ON \
            -DRUN_CLANG_TIDY=OFF
      - name: Build
        run: cmake --build obj --config RelWithDebInfo
      - name: Test
        if: ${{ needs.what_to_make.outputs.make_tests == 'true' }}
        run: cmake -E chdir obj ctest -j $(nproc) --build-config RelWithDebInfo --output-on-failure
      - name: Install
        run: cmake --build obj --config RelWithDebInfo --target install/strip
      - uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ github.job }}
          path: pfx/**/*

  fedora-39-from-tarball:
    needs: [ make-source-tarball, what_to_make ]
    if: ${{ needs.what_to_make.outputs.make_cli == 'true' || needs.what_to_make.outputs.make_daemon == 'true' || needs.what_to_make.outputs.make_gtk == 'true' || needs.what_to_make.outputs.make_qt == 'true' || needs.what_to_make.outputs.make_tests == 'true' || needs.what_to_make.outputs.make_utils == 'true' }}
    runs-on: ubuntu-22.04
    container:
      image: fedora:39
    steps:
      - name: Show Configuration
        run: |
          echo '${{ toJSON(needs) }}'
          echo '${{ toJSON(runner) }}'
          cat /etc/os-release
      - name: Get Dependencies
        run: |
          set -ex
          dnf install -y \
            ca-certificates \
            cmake \
            fmt-devel \
            gcc-c++ \
            gettext \
            google-crc32c-devel \
            libcurl-devel \
            libdeflate-devel \
            libevent-devel \
            libnatpmp-devel \
            libpsl-devel \
            miniupnpc-devel \
            ninja-build \
            openssl-devel \
            pkgconf-pkg-config \
            xz
      - name: Get NPM
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Get Dependencies (GTK)
        if: ${{ needs.what_to_make.outputs.make_gtk == 'true' }}
        run: dnf install -y glibmm2.68-devel gtkmm4.0-devel
      - name: Get Dependencies (Qt6)
        if: ${{ needs.what_to_make.outputs.make_qt == 'true' }}
        run: dnf install -y qt6-qtbase-devel qt6-qtsvg-devel qt6-qttools-devel
      - name: Get Source
        uses: actions/download-artifact@v4
        with:
          name: source-tarball
      - name: Extract Source
        run: mkdir src && tar xf transmission*.tar.* -C src --strip-components 1
      - name: Configure
        run: |
          cmake \
            -S src \
            -B obj \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_INSTALL_PREFIX=pfx \
            -DENABLE_CLI=${{ (needs.what_to_make.outputs.cmake_enable_cli }} \
            -DENABLE_DAEMON=${{ needs.what_to_make.outputs.cmake_enable_daemon }} \
            -DENABLE_GTK=${{ (needs.what_to_make.outputs.cmake_enable_gtk }} \
            -DENABLE_MAC=OFF \
            -DENABLE_QT=${{ needs.what_to_make.outputs.cmake_enable_qt }} \
            -DENABLE_TESTS=${{ needs.what_to_make.outputs.cmake_enable_tests }} \
            -DENABLE_UTILS=${{ needs.what_to_make.outputs.cmake_enable_utils }} \
            -DREBUILD_WEB=${{ needs.what_to_make.outputs.cmake_rebuild_web }}
            -DENABLE_DEPRECATED=ON \
            -DENABLE_WERROR=OFF \
            -DRUN_CLANG_TIDY=OFF \
            -DUSE_SYSTEM_Crc32c=ON
      - name: Build
        run: cmake --build obj --config RelWithDebInfo
      - name: Test
        if: ${{ needs.what_to_make.outputs.make_tests == 'true' }}
        run: cmake -E chdir obj ctest -j $(nproc) --build-config RelWithDebInfo --output-on-failure
      - name: Install
        run: cmake --build obj --config RelWithDebInfo --target install/strip
      - uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ github.job }}
          path: pfx/**/*

  ubuntu-22-04-from-tarball:
    needs: [ make-source-tarball, what_to_make ]
    if: ${{ needs.what_to_make.outputs.make_cli == 'true' || needs.what_to_make.outputs.make_daemon == 'true' || needs.what_to_make.outputs.make_gtk == 'true' || needs.what_to_make.outputs.make_qt == 'true' || needs.what_to_make.outputs.make_tests == 'true' || needs.what_to_make.outputs.make_utils == 'true' }}
    runs-on: ubuntu-22.04
    steps:
      - name: Show Configuration
        run: |
          echo '${{ toJSON(needs) }}'
          echo '${{ toJSON(runner) }}'
          cat /etc/os-release
      - name: Get Dependencies
        run: |
          set -ex
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            appstream \
            ca-certificates \
            clang \
            cmake \
            gettext \
            libcurl4-openssl-dev \
            libdeflate-dev \
            libevent-dev \
            libfmt-dev \
            libminiupnpc-dev \
            libnatpmp-dev \
            libpsl-dev \
            libssl-dev \
            ninja-build
      - name: Get NPM
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Get Dependencies (GTK)
        if: ${{ needs.what_to_make.outputs.make_gtk == 'true' }}
        run: sudo apt-get install -y --no-install-recommends libglibmm-2.4-dev libgtkmm-3.0-dev
      - name: Get Dependencies (Qt5)
        if: ${{ needs.what_to_make.outputs.make_qt == 'true' }}
        run: sudo apt-get install -y --no-install-recommends qtbase5-dev libqt5svg5-dev qttools5-dev
      - name: Get Source
        uses: actions/download-artifact@v4
        with:
          name: source-tarball
      - name: Extract Source
        run: mkdir src && tar xf transmission*.tar.* -C src --strip-components 1
      - name: Configure
        run: |
          cmake \
            -S src \
            -B obj \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_INSTALL_PREFIX=pfx \
            -DENABLE_CLI=${{ (needs.what_to_make.outputs.cmake_enable_cli }} \
            -DENABLE_DAEMON=${{ needs.what_to_make.outputs.cmake_enable_daemon }} \
            -DENABLE_GTK=${{ (needs.what_to_make.outputs.cmake_enable_gtk }} \
            -DENABLE_MAC=OFF \
            -DENABLE_QT=${{ needs.what_to_make.outputs.cmake_enable_qt }} \
            -DENABLE_TESTS=OFF \
            -DENABLE_UTILS=${{ needs.what_to_make.outputs.cmake_enable_utils }} \
            -DREBUILD_WEB=${{ needs.what_to_make.outputs.cmake_rebuild_web }}
            -DENABLE_WERROR=ON \
            -DRUN_CLANG_TIDY=OFF
      - name: Make
        run: cmake --build obj --config RelWithDebInfo
      - name: Test
        if: ${{ needs.what_to_make.outputs.make_tests == 'true' }}
        env:
          TMPDIR: /private/tmp
        run: cmake -E chdir obj ctest -j $(nproc) --build-config RelWithDebInfo --output-on-failure
      - name: Install
        run: cmake --build obj --config RelWithDebInfo --target install/strip
      - uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ github.job }}
          path: pfx/**/*

  android:
    needs: [ what_to_make ]
    if: ${{ needs.what_to_make.outputs.make_android == 'true' }}
    runs-on: ubuntu-22.04
    env:
      VCPKG_DEFAULT_TRIPLET: arm64-android
    steps:
    - name: Get Dependencies
      run: |
        set -ex
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          ninja-build

    - name: Get Source
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v3
      with:
        gradle-version: 7.6

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK
      run: sdkmanager "ndk;26.1.10909125"

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: 53bef8994c541b6561884a8395ea35715ece75db # 2024.01.12

    - name: Install vcpkg packages
      run: |
        vcpkg install openssl curl

    - name: Build Transmission
      working-directory: ./android
      run: |
        gradle build

  ubuntu-24-04-cxx-23:
    needs: [ what_to_make ]
    if: ${{ needs.what_to_make.outputs.make_cli == 'true' || needs.what_to_make.outputs.make_daemon == 'true' || needs.what_to_make.outputs.make_gtk == 'true' || needs.what_to_make.outputs.make_qt == 'true' || needs.what_to_make.outputs.make_utils == 'true' }}
    runs-on: ubuntu-24.04
    steps:
      - name: Show Configuration
        run: |
          echo '${{ toJSON(needs) }}'
          echo '${{ toJSON(runner) }}'
          cat /etc/os-release
      - name: Get Dependencies
        run: |
          set -ex
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            appstream \
            ca-certificates \
            clang \
            cmake \
            gettext \
            libcurl4-openssl-dev \
            libdeflate-dev \
            libevent-dev \
            libfmt-dev \
            libminiupnpc-dev \
            libnatpmp-dev \
            libpsl-dev \
            libssl-dev \
            ninja-build
      - name: Get Dependencies (GTK)
        if: ${{ needs.what_to_make.outputs.make_gtk == 'true' }}
        run: sudo apt-get install -y --no-install-recommends libglibmm-2.4-dev libgtkmm-3.0-dev
      - name: Get Dependencies (Qt6)
        if: ${{ needs.what_to_make.outputs.make_qt == 'true' }}
        run: sudo apt-get install -y --no-install-recommends qt6-svg-dev qt6-tools-dev
      - name: Get Source
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: src
      - name: Configure
        run: |
          cmake \
            -S src \
            -B obj \
            -G Ninja \
            -DCMAKE_CXX_STANDARD=23 \
            -DCMAKE_CXX_COMPILER='clang++' \
            -DCMAKE_C_COMPILER='clang' \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_INSTALL_PREFIX=pfx \
            -DENABLE_CLI=${{ (needs.what_to_make.outputs.cmake_enable_cli }} \
            -DENABLE_DAEMON=${{ needs.what_to_make.outputs.cmake_enable_daemon }} \
            -DENABLE_GTK=${{ (needs.what_to_make.outputs.cmake_enable_gtk }} \
            -DENABLE_MAC=OFF \
            -DENABLE_QT=${{ needs.what_to_make.outputs.cmake_enable_qt }} \
            -DENABLE_TESTS=OFF \
            -DENABLE_UTILS=${{ needs.what_to_make.outputs.cmake_enable_utils }} \
            -DREBUILD_WEB=OFF \
            -DENABLE_WERROR=ON \
            -DRUN_CLANG_TIDY=OFF
      - name: Make
        run: cmake --build obj --config RelWithDebInfo -- "-k 0"
